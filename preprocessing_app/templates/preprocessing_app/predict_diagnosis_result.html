{% extends 'preprocessing_app/base.html' %}
{% load static %}

{% block title %}Diagnosis Report ¬∑ ArteriAI{% endblock %}

{% block content %}
<section class="ai-page px-4 sm:px-6 lg:px-10">
    <div class="mx-auto max-w-5xl w-full" id="reportContent">
        <div class="ai-card ai-card--soft p-8 md:p-10 space-y-10">
            <div class="text-center space-y-3">
                <p class="text-sm uppercase tracking-[0.3em] text-slate-400">ArteriAI ‚Ä¢ Ensemble severity dossier</p>
                <h1 class="text-3xl font-bold text-slate-900">Severity assessment</h1>
                <p class="text-slate-500">Coronary AI intelligence summary</p>
            </div>

            {% if predictions %}
                {% with ensemble=predictions.ensemble %}
                <div class="space-y-6">
                    <div class="text-center space-y-3">
                        <div class="inline-flex items-center px-6 py-3 rounded-full text-lg font-semibold shadow-md
                            {% if ensemble.severity_level == 'high' %}
                                bg-gradient-to-r from-rose-500 to-orange-400 text-white
                            {% elif ensemble.severity_level == 'moderate' %}
                                bg-gradient-to-r from-amber-300 to-yellow-400 text-amber-900
                            {% else %}
                                bg-gradient-to-r from-emerald-300 to-teal-400 text-emerald-900
                            {% endif %}">
                            {{ ensemble.prediction }}
                        </div>
                        <p class="text-sm text-slate-500 uppercase tracking-[0.4em]">Final ensemble severity</p>
                    </div>
                    <div class="space-y-3">
                        <div class="w-full h-4 rounded-full bg-slate-100 overflow-hidden">
                            <div 
                                class="h-full rounded-full bg-gradient-to-r from-indigo-500 via-blue-500 to-fuchsia-500 transition-all"
                                style="width: {{ ensemble.confidence|floatformat:2 }}%"
                            ></div>
                        </div>
                        <div class="flex justify-between text-sm text-slate-500">
                            <span>{{ ensemble.confidence|floatformat:1 }}% confidence</span>
                            <span>Risk score {{ ensemble.probability|floatformat:2 }}%</span>
                        </div>
                    </div>
                </div>
                {% endwith %}

                <div class="grid gap-4 md:grid-cols-3">
                    <div class="ai-stat-card text-center">
                        <p class="ai-stat-label">Low severity votes</p>
                        <p class="ai-stat-value text-emerald-500">{{ predictions.ensemble.votes.low }}</p>
                    </div>
                    <div class="ai-stat-card text-center">
                        <p class="ai-stat-label">Moderate severity votes</p>
                        <p class="ai-stat-value text-amber-500">{{ predictions.ensemble.votes.moderate }}</p>
                    </div>
                    <div class="ai-stat-card text-center">
                        <p class="ai-stat-label">High severity votes</p>
                        <p class="ai-stat-value text-rose-500">{{ predictions.ensemble.votes.high }}</p>
                    </div>
                </div>

                <div class="ai-divider"></div>

                <div class="grid gap-6 md:grid-cols-3">
                    {% with predictions.vgg16 as model %}
                    <div class="ai-card ai-card--outline p-6 text-center space-y-3">
                        <div class="text-3xl" aria-hidden="true">üß†</div>
                        <h3 class="font-semibold text-slate-900">VGG16</h3>
                        <p class="text-lg font-bold
                            {% if model.severity_level == 'high' %}
                                text-rose-500
                            {% elif model.severity_level == 'moderate' %}
                                text-amber-500
                            {% else %}
                                text-emerald-500
                            {% endif %}">
                            {{ model.prediction }}
                        </p>
                        <div class="w-full h-2 rounded-full bg-slate-100">
                            <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500" style="width: {{ model.confidence|floatformat:2 }}%"></div>
                        </div>
                        <p class="text-sm text-slate-500">Probability {{ model.probability|floatformat:1 }}%</p>
                    </div>
                    {% endwith %}

                    {% with predictions.resnet50 as model %}
                    <div class="ai-card ai-card--outline p-6 text-center space-y-3">
                        <div class="text-3xl" aria-hidden="true">‚ö°</div>
                        <h3 class="font-semibold text-slate-900">ResNet50</h3>
                        <p class="text-lg font-bold
                            {% if model.severity_level == 'high' %}
                                text-rose-500
                            {% elif model.severity_level == 'moderate' %}
                                text-amber-500
                            {% else %}
                                text-emerald-500
                            {% endif %}">
                            {{ model.prediction }}
                        </p>
                        <div class="w-full h-2 rounded-full bg-slate-100">
                            <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500" style="width: {{ model.confidence|floatformat:2 }}%"></div>
                        </div>
                        <p class="text-sm text-slate-500">Probability {{ model.probability|floatformat:1 }}%</p>
                    </div>
                    {% endwith %}

                    {% with predictions.efficientnet as model %}
                    <div class="ai-card ai-card--outline p-6 text-center space-y-3">
                        <div class="text-3xl" aria-hidden="true">üöÄ</div>
                        <h3 class="font-semibold text-slate-900">EfficientNet</h3>
                        <p class="text-lg font-bold
                            {% if model.severity_level == 'high' %}
                                text-rose-500
                            {% elif model.severity_level == 'moderate' %}
                                text-amber-500
                            {% else %}
                                text-emerald-500
                            {% endif %}">
                            {{ model.prediction }}
                        </p>
                        <div class="w-full h-2 rounded-full bg-slate-100">
                            <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500" style="width: {{ model.confidence|floatformat:2 }}%"></div>
                        </div>
                        <p class="text-sm text-slate-500">Probability {{ model.probability|floatformat:1 }}%</p>
                    </div>
                    {% endwith %}
                </div>

                <div class="ai-divider"></div>

                <div class="text-center text-slate-500">
                    <p>Analysis completed: {{ predictions.timestamp|date:"F j, Y, g:i A" }}</p>
                    <p>Image evaluated: {{ predictions.image_name }}</p>
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-3">
                    <button 
                        type="button" 
                        onclick="saveReport()" 
                        class="inline-flex items-center justify-center rounded-2xl border border-slate-200 px-5 py-3 text-slate-700 hover:bg-slate-50"
                    >
                        <span class="mr-2" aria-hidden="true">üíæ</span>
                        Save report
                    </button>
                    <button 
                        type="button" 
                        onclick="printReport()" 
                        class="inline-flex items-center justify-center rounded-2xl border border-slate-200 px-5 py-3 text-slate-700 hover:bg-slate-50"
                    >
                        <span class="mr-2" aria-hidden="true">üñ®Ô∏è</span>
                        Print report
                    </button>
                    <a 
                        href="{% url 'predict_diagnosis' %}" 
                        class="inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-indigo-600 to-blue-600 px-5 py-3 text-white shadow-lg shadow-indigo-300/40"
                    >
                        <span class="mr-2" aria-hidden="true">üîÑ</span>
                        New analysis
                    </a>
                </div>
            {% else %}
                <div class="text-center space-y-4 py-12">
                    <h2 class="text-2xl font-bold text-slate-900">No prediction data</h2>
                    <p class="text-slate-500 max-w-md mx-auto">We could not find stored predictions. Launch a new analysis to generate a report.</p>
                    <a 
                        href="{% url 'predict_diagnosis' %}" 
                        class="inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-indigo-600 to-blue-600 px-6 py-3 text-white shadow-lg shadow-indigo-300/40"
                    >
                        Return to predictor
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
    function saveReport() {
        printReport();
    }

    function printReport() {
        const reportContent = document.getElementById('reportContent');
        if (!reportContent) {
            return;
        }

        const printWindow = window.open('', '_blank');
        const styles = `
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                body { 
                    font-family: 'Inter', sans-serif; 
                    padding: 2rem;
                    background: white;
                }
                @media print {
                    .no-print { display: none !important; }
                    .bg-gradient-to-br { background: white !important; }
                    .backdrop-blur-lg { backdrop-filter: none !important; }
                    .shadow-lg { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1) !important; }
                    .border-white { border-color: #e5e7eb !important; }
                }
                .bg-gradient-to-r { background-image: none !important; }
                .from-blue-600 { background-color: #2563eb !important; }
                .to-pink-500 { background-color: #ec4899 !important; }
            </style>
        `;

        // Clone the content and hide action buttons for print
        const contentClone = reportContent.cloneNode(true);
        const actionButtons = contentClone.querySelectorAll('button, a[href*="predict_diagnosis"]');
        actionButtons.forEach(btn => {
            btn.classList.add('no-print');
        });

        printWindow.document.write(`
            <html>
                <head>
                    <title>ArteriAI Diagnosis Report</title>
                    ${styles}
                </head>
                <body>
                    ${contentClone.innerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();

        setTimeout(() => {
            printWindow.print();
        }, 400);
    }
</script>
{% endblock %}