{% extends 'preprocessing_app/base.html' %}
{% load static %}

{% block title %}ArteriAI ¬∑ Coronary Imaging Intelligence{% endblock %}

{% block content %}
<section class="px-4 sm:px-6 lg:px-10">
    <div class="mx-auto max-w-6xl space-y-12">
        <div class="grid gap-12 lg:grid-cols-2 lg:items-center">
            <div class="space-y-6">
                <span class="ai-badge">
                    <span class="text-base" aria-hidden="true">ü´Ä</span>
                    Coronary Upload Lab
                </span>
                <div>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 leading-tight">
                        <span class="ai-gradient">AI-ready coronary imaging</span> pipeline
                    </h1>
                    <p class="mt-4 text-lg text-slate-600 leading-relaxed">
                        Drag in PNG or JPEG angiography frames. ArteriAI harmonizes naming, calibrates contrast, and stages each file for severity analysis‚ÄîDICOM studies are auto-converted in the background.
                    </p>
                </div>
                <div class="ai-stats">
                    <div class="ai-stat-card">
                        <p class="ai-stat-label">Accepted formats</p>
                        <p class="ai-stat-value">PNG ¬∑ JPEG</p>
                        <p class="text-xs text-slate-500 mt-1">DICOM fallback supported</p>
                    </div>
                    <div class="ai-stat-card">
                        <p class="ai-stat-label">Avg. prep time</p>
                        <p class="ai-stat-value">&lt; 30s</p>
                        <p class="text-xs text-slate-500 mt-1">per batch on-device</p>
                    </div>
                    <div class="ai-stat-card">
                        <p class="ai-stat-label">Enhancement stages</p>
                        <p class="ai-stat-value">3-layer</p>
                        <p class="text-xs text-slate-500 mt-1">denoise ¬∑ CLAHE ¬∑ sharpen</p>
                    </div>
                </div>
                <div class="ai-chip-group">
                    <span class="ai-chip">Auto directory ingestion</span>
                    <span class="ai-chip">HIPAA-safe temp storage</span>
                    <span class="ai-chip">AI quality scoring</span>
                </div>
            </div>
            <div class="ai-card ai-card--soft p-8 shadow-2xl shadow-indigo-200/60">
                <div class="mb-8">
                    <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Upload workspace</p>
                    <h2 class="text-2xl font-semibold text-slate-900">Batch coronary uploads</h2>
                    <p class="text-sm text-slate-500 mt-2">Drag folders or choose files to queue them for preprocessing.</p>
                </div>
                <form id="uploadForm" method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}
                    <input type="hidden" name="dataset_type" id="datasetType" value="images" />
                    <div class="ai-grid rounded-3xl border border-dashed border-indigo-200/80 bg-gradient-to-b from-white/90 to-indigo-50/40 p-10 text-center cursor-pointer transition hover:border-indigo-400" id="dropzone">
                        <div class="flex flex-col items-center space-y-4">
                            <div class="flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 text-3xl text-white shadow-lg">
                                üì§
                            </div>
                            <div>
                                <p class="text-2xl font-semibold text-slate-900">Drop files or browse</p>
                                <p class="text-sm text-slate-500 mt-2">
                                    Accepted formats: <span id="acceptedFormats" class="font-semibold text-indigo-600">.jpeg / .jpg ¬∑ .png</span> ¬∑ drag directories for batch ingest
                                </p>
                            </div>
                            <div class="flex gap-2 flex-wrap justify-center text-xs font-semibold">
                                <span class="ai-pill bg-indigo-50 text-indigo-600 border border-indigo-200">PNG</span>
                                <span class="ai-pill bg-pink-50 text-pink-600 border border-pink-200">JPEG</span>
                            </div>
                        </div>
                        <input
                            type="file"
                            id="fileInput"
                            name="jpeg_files"
                            multiple
                            webkitdirectory
                            directory
                            accept=".jpg,.jpeg,.png"
                            class="hidden"
                        />
                    </div>
                    <div class="file-list space-y-3 max-h-64 overflow-y-auto rounded-2xl border border-slate-200/70 bg-white/70 p-4 shadow-inner shadow-slate-200" id="fileList" aria-live="polite"></div>
                    <div class="error-message" id="errorMessage"></div>
                    <button
                        type="submit"
                        class="w-full group relative overflow-hidden rounded-2xl bg-gradient-to-r from-indigo-600 via-blue-600 to-fuchsia-500 py-4 text-white font-semibold shadow-lg shadow-indigo-400/40 transition hover:translate-y-[-1px] disabled:opacity-50 disabled:translate-y-0 disabled:shadow-none"
                        id="processButton"
                        disabled
                    >
                        <span class="relative z-10 flex items-center justify-center text-lg">
                            <span class="mr-3 text-xl" aria-hidden="true">‚ö°</span>
                            Process batch
                            <span class="ml-2 text-sm opacity-80">(</span>
                            <span id="fileCount" class="mx-1 text-sm opacity-90">0</span>
                            <span class="text-sm opacity-80">files)</span>
                        </span>
                        <div class="absolute inset-0 opacity-0 transition group-hover:opacity-20 bg-white"></div>
                    </button>
                    <p class="text-xs text-slate-500 text-center">Files are stored temporarily during enhancement and deleted after processing.</p>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Modern Processing Modal -->
<div
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden transition-all duration-300"
    id="processingModal"
    role="alertdialog"
    aria-modal="true"
    aria-labelledby="processingHeading"
    aria-describedby="processingStatus"
>
    <div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl p-10 max-w-lg w-full mx-4 border border-white/50 transform transition-all duration-300 scale-95 animate-scale-in">
        <!-- Animated Icon -->
        <div class="relative w-24 h-24 mx-auto mb-6">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl opacity-20 animate-pulse"></div>
            <div class="absolute inset-2 border-4 border-blue-200 rounded-xl animate-spin"></div>
            <div class="absolute inset-4 border-4 border-transparent border-t-blue-500 rounded-lg animate-spin" style="animation-duration: 1.5s"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl">‚öôÔ∏è</span>
            </div>
        </div>

        <h2 id="processingHeading" class="text-2xl font-bold text-gray-900 text-center mb-6">Processing Images</h2>
        
        <!-- Progress Bar -->
        <div class="mb-6">
            <div class="w-full bg-gray-200/80 rounded-full h-3 mb-3 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500 ease-out shadow-inner" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span>0%</span>
                <span id="progressPercentage">0%</span>
                <span>100%</span>
            </div>
        </div>
        
        <p class="text-gray-600 text-center mb-8 text-lg font-medium" id="processingStatus">Initializing upload process‚Ä¶</p>

        <!-- Processing Steps -->
        <div class="space-y-4">
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-blue-50/50 border border-blue-200/50" data-step="upload">
                <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white font-bold">1</div>
                <div>
                    <div class="font-semibold text-gray-900">Uploading Files</div>
                    <div class="text-sm text-gray-600">Securely transferring your medical images</div>
                </div>
                <div class="ml-auto">
                    <div class="w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-gray-100/50 border border-gray-200/50" data-step="validation">
                <div class="w-10 h-10 bg-gray-400 rounded-xl flex items-center justify-center text-white font-bold">2</div>
                <div>
                    <div class="font-semibold text-gray-600">Validating Images</div>
                    <div class="text-sm text-gray-500">Checking format and quality standards</div>
                </div>
            </div>
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-gray-100/50 border border-gray-200/50" data-step="processing">
                <div class="w-10 h-10 bg-gray-400 rounded-xl flex items-center justify-center text-white font-bold">3</div>
                <div>
                    <div class="font-semibold text-gray-600">Processing Images</div>
                    <div class="text-sm text-gray-500">AI-powered enhancement and analysis</div>
                </div>
            </div>
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-gray-100/50 border border-gray-200/50" data-step="complete">
                <div class="w-10 h-10 bg-gray-400 rounded-xl flex items-center justify-center text-white font-bold">4</div>
                <div>
                    <div class="font-semibold text-gray-600">Completing Process</div>
                    <div class="text-sm text-gray-500">Finalizing and preparing results</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes scale-in {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    .animate-scale-in {
        animation: scale-in 0.3s ease-out;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    
    .scrollbar-thumb-blue-200::-webkit-scrollbar-thumb {
        background-color: #bfdbfe;
        border-radius: 3px;
    }
    
    .scrollbar-track-transparent::-webkit-scrollbar-track {
        background: transparent;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const uploadForm = document.getElementById("uploadForm");
    const processingModal = document.getElementById("processingModal");
    const progressBar = document.getElementById("progressBar");
    const progressPercentage = document.getElementById("progressPercentage");
    const processingStatus = document.getElementById("processingStatus");
    const errorMessage = document.getElementById("errorMessage");
    const acceptedFormats = document.getElementById("acceptedFormats");
    const fileCount = document.getElementById("fileCount");
    const processButton = document.getElementById("processButton");

    // Drag and drop handlers
    dropzone.addEventListener("click", () => fileInput.click());

    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ["dragenter", "dragover"].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => {
            dropzone.classList.add("border-blue-400", "bg-blue-50", "scale-105");
        });
    });

    ["dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => {
            dropzone.classList.remove("border-blue-400", "bg-blue-50", "scale-105");
        });
    });

    // File handling
    dropzone.addEventListener("drop", handleDrop);
    fileInput.addEventListener("change", handleFiles);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const items = dt.items;

        // Check if any items are directories
        let hasDirectories = false;
        for (let i = 0; i < items.length; i++) {
            const entry = items[i].webkitGetAsEntry();
            if (entry && entry.isDirectory) {
                hasDirectories = true;
                break;
            }
        }

        if (hasDirectories) {
            fileInput.webkitdirectory = true;
            fileInput.click();
        } else {
            const files = dt.files;
            validateAndHandleFiles(files);
        }
    }

    function handleFiles(e) {
        const files = e.target.files;
        validateAndHandleFiles(files);
        fileInput.webkitdirectory = false;
    }

    function validateAndHandleFiles(files) {
        const validFiles = [];
        const allowedExtensions = ['jpg', 'jpeg', 'png'];

        Array.from(files).forEach((file) => {
            const extension = file.name.toLowerCase().split(".").pop();
            if (allowedExtensions.includes(extension)) {
                validFiles.push(file);
            }
        });

        if (validFiles.length === 0) {
            showError("Please upload valid image files (JPG, JPEG, or PNG)");
            return;
        }

        updateFileList(validFiles);
        errorMessage.innerHTML = "";
    }

    function updateFileList(files) {
        fileList.innerHTML = "";
        let totalFiles = 0;

        // Group files by directory
        const filesByDirectory = {};

        Array.from(files).forEach((file) => {
            const pathParts = file.webkitRelativePath
                ? file.webkitRelativePath.split("/")
                : [file.name];
            const directory = pathParts.length > 1 ? pathParts[0] : "Root";

            if (!filesByDirectory[directory]) {
                filesByDirectory[directory] = [];
            }
            filesByDirectory[directory].push(file);
            totalFiles++;
        });

        // Display files grouped by directory
        for (const [directory, dirFiles] of Object.entries(filesByDirectory)) {
            if (Object.keys(filesByDirectory).length > 1) {
                const dirHeader = document.createElement("div");
                dirHeader.className = "flex items-center space-x-2 mt-4 mb-3 p-3 bg-gray-100/50 rounded-xl";
                dirHeader.innerHTML = `
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    <span class="font-semibold text-blue-700">${directory}</span>
                    <span class="text-sm text-gray-500">(${dirFiles.length} files)</span>
                `;
                fileList.appendChild(dirHeader);
            }

            dirFiles.forEach((file, index) => {
                const fileItem = document.createElement("div");
                fileItem.className = "flex items-center justify-between p-4 bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 hover:border-blue-200/50 transition-all duration-200 group";

                const size = formatFileSize(file.size);
                const type = file.name.split(".").pop().toUpperCase();
                const displayName = file.webkitRelativePath
                    ? file.webkitRelativePath.split("/").slice(1).join("/")
                    : file.name;

                fileItem.innerHTML = `
                    <div class="flex items-center space-x-4 flex-1 min-w-0">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-sm">
                            ${type.substring(0, 3)}
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="font-medium text-gray-900 truncate">${displayName}</div>
                            <div class="text-sm text-gray-500 flex items-center space-x-2">
                                <span>${type}</span>
                                <span>‚Ä¢</span>
                                <span>${size}</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="opacity-0 group-hover:opacity-100 w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg flex items-center justify-center transition-all duration-200 transform hover:scale-110 remove-file" data-index="${index}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;

                fileList.appendChild(fileItem);
            });
        }

        // Update file count and button state
        fileCount.textContent = totalFiles;
        const dataTransfer = new DataTransfer();
        Array.from(files).forEach((file) => {
            dataTransfer.items.add(file);
        });
        fileInput.files = dataTransfer.files;
        processButton.disabled = false;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function showError(message) {
        errorMessage.innerHTML = `
            <div class="bg-red-50/80 backdrop-blur-sm border border-red-200 rounded-2xl p-4 shadow-lg animate-fade-in">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="text-red-800 font-medium">${message}</div>
                </div>
            </div>
        `;
    }

    function clearFiles() {
        fileList.innerHTML = "";
        fileInput.value = "";
        errorMessage.innerHTML = "";
        fileCount.textContent = "0";
        processButton.disabled = true;
    }

    // Form submission
    uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (fileList.children.length === 0) {
            showError("Please select files to upload");
            return;
        }

        const formData = new FormData();
        const files = fileInput.files;

        Array.from(files).forEach((file) => {
            formData.append("jpeg_files", file);
        });

        formData.append("dataset_type", "images");

        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        processingModal.classList.remove("hidden");
        updateProcessingStep("upload");

        try {
            const response = await fetch("", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": csrfToken,
                    "X-Requested-With": "XMLHttpRequest",
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.status === "success") {
                const imageId = data.image_id;
                let progress = 0;

                const pollInterval = setInterval(async () => {
                    try {
                        progress += 2;
                        if (progress > 100) progress = 100;
                        progressBar.style.width = `${progress}%`;
                        progressPercentage.textContent = `${progress}%`;

                        if (progress <= 25) {
                            updateProcessingStep("upload");
                            processingStatus.textContent = "Uploading files securely...";
                        } else if (progress <= 50) {
                            updateProcessingStep("validation");
                            processingStatus.textContent = "Validating image quality...";
                        } else if (progress <= 85) {
                            updateProcessingStep("processing");
                            processingStatus.textContent = "Processing with AI models...";
                        } else {
                            updateProcessingStep("complete");
                            processingStatus.textContent = "Finalizing results...";
                        }

                        if (progress % 10 === 0) {
                            const statusResponse = await fetch(`/progress/${imageId}/`, {
                                headers: {
                                    "X-Requested-With": "XMLHttpRequest",
                                },
                            });

                            if (statusResponse.ok) {
                                const statusData = await statusResponse.json();
                                if (statusData.status === "completed" || statusData.redirect) {
                                    clearInterval(pollInterval);
                                    window.location.href = statusData.redirect || data.redirect_url;
                                    return;
                                }
                            }
                        }

                        if (progress >= 100) {
                            clearInterval(pollInterval);
                            window.location.href = data.redirect_url;
                        }
                    } catch (error) {
                        console.error("Status check error:", error);
                        if (progress >= 100) {
                            clearInterval(pollInterval);
                            window.location.href = data.redirect_url;
                        }
                    }
                }, 300);
            } else {
                throw new Error(data.message || "Upload failed");
            }
        } catch (error) {
            console.error("Upload error:", error);
            showError(error.message || "An error occurred during upload");
            processingModal.classList.add("hidden");
        }
    });

    function updateProcessingStep(step) {
        document.querySelectorAll(".processing-step").forEach((s) => {
            s.classList.remove("bg-blue-50/50", "border-blue-200/50");
            s.classList.add("bg-gray-100/50", "border-gray-200/50");
            
            const numberDiv = s.querySelector("div:first-child");
            const spinner = s.querySelector("div:last-child .animate-spin");
            
            numberDiv.classList.remove("bg-blue-500", "bg-gray-400");
            numberDiv.classList.add("bg-gray-400");
            
            if (spinner) {
                spinner.classList.add("hidden");
            }
            
            if (s.dataset.step === step) {
                s.classList.remove("bg-gray-100/50", "border-gray-200/50");
                s.classList.add("bg-blue-50/50", "border-blue-200/50");
                numberDiv.classList.remove("bg-gray-400");
                numberDiv.classList.add("bg-blue-500");
                
                if (spinner) {
                    spinner.classList.remove("hidden");
                }
            }
        });
    }
</script>
{% endblock %}