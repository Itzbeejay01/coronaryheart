{% extends 'preprocessing_app/base.html' %}
{% load static %}

{% block title %}ArteriAI ¬∑ Coronary Imaging Intelligence{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50/20 py-12 px-4 sm:px-6 lg:px-8">
    <!-- Animated Background Elements -->
    <div class="fixed inset-0 -z-10 overflow-hidden">
        <div class="absolute -top-40 -right-32 w-80 h-80 bg-gradient-to-r from-blue-400/10 to-purple-400/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-32 w-80 h-80 bg-gradient-to-r from-emerald-400/10 to-cyan-400/10 rounded-full blur-3xl"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-gradient-to-r from-orange-400/5 to-pink-400/5 rounded-full blur-3xl"></div>
    </div>

    <div class="max-w-4xl mx-auto relative">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-blue-500/10 text-blue-700 border border-blue-200/50 backdrop-blur-sm mb-6">
                <span class="mr-2 animate-pulse" aria-hidden="true">üì°</span>
                Batch-Ready Coronary Preprocessing
            </span>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6 bg-gradient-to-r from-gray-900 to-blue-900 bg-clip-text text-transparent">
                Upload Medical Images
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
                Drag-and-drop DICOM or JPEG studies. ArteriAI cleans, enhances, and
                prepares each image for downstream ensemble diagnosis.
            </p>
        </div>

        <!-- Navigation Menu -->
        <nav class="flex justify-center space-x-3 mb-12" aria-label="Workflow shortcuts">
            <a href="{% url 'index' %}" class="group px-6 py-3 rounded-2xl text-sm font-semibold text-gray-600 hover:text-gray-900 bg-white/50 backdrop-blur-sm border border-gray-200/50 hover:border-gray-300/50 hover:shadow-lg transition-all duration-300">
                <span class="group-hover:scale-110 transition-transform">üè†</span>
                <span class="ml-2">Home</span>
            </a>
            <a href="{% url 'upload' %}" class="group px-6 py-3 rounded-2xl text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                <span class="group-hover:rotate-12 transition-transform">üîç</span>
                <span class="ml-2">Image Analysis</span>
            </a>
            <a href="{% url 'predict_diagnosis' %}" class="group px-6 py-3 rounded-2xl text-sm font-semibold text-gray-600 hover:text-gray-900 bg-white/50 backdrop-blur-sm border border-gray-200/50 hover:border-gray-300/50 hover:shadow-lg transition-all duration-300">
                <span class="group-hover:scale-110 transition-transform">üß™</span>
                <span class="ml-2">Predict Diagnosis</span>
            </a>
        </nav>

        <!-- Upload Card -->
        <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/50 transform transition-all duration-300 hover:shadow-3xl">
            <div class="p-8">
                <form id="uploadForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="dataset_type" id="datasetType" value="dicom" />

                    <!-- Dataset Selector -->
                    <div class="flex flex-wrap gap-3 mb-8" role="group" aria-label="Dataset presets">
                        <button type="button" class="dataset-option group px-6 py-4 rounded-2xl text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg hover:from-blue-700 hover:to-blue-800 transform hover:scale-105 transition-all duration-300" data-type="dicom">
                            <span class="group-hover:scale-110 transition-transform">üí†</span>
                            <span class="ml-2">DICOM</span>
                        </button>
                        <button type="button" class="dataset-option group px-6 py-4 rounded-2xl text-sm font-semibold text-gray-700 bg-white/80 backdrop-blur-sm border border-gray-200/50 hover:border-gray-300/50 hover:shadow-lg hover:bg-white transform hover:scale-105 transition-all duration-300" data-type="cbis-ddsm">
                            <span class="group-hover:scale-110 transition-transform">üñºÔ∏è</span>
                            <span class="ml-2">CBIS-DDSM</span>
                        </button>
                        <button type="button" class="dataset-option group px-6 py-4 rounded-2xl text-sm font-semibold text-gray-700 bg-white/80 backdrop-blur-sm border border-gray-200/50 hover:border-gray-300/50 hover:shadow-lg hover:bg-white transform hover:scale-105 transition-all duration-300" data-type="mri">
                            <span class="group-hover:scale-110 transition-transform">üß≤</span>
                            <span class="ml-2">MRI</span>
                        </button>
                    </div>

                    <!-- Dropzone -->
                    <div class="relative mb-6">
                        <div class="dropzone border-3 border-dashed border-gray-300/80 rounded-3xl p-12 text-center cursor-pointer transition-all duration-500 hover:border-blue-400/80 hover:bg-blue-50/30 relative overflow-hidden group" id="dropzone">
                            <!-- Animated Grid Background -->
                            <div class="absolute inset-0 opacity-[0.03] pointer-events-none" aria-hidden="true">
                                <div class="grid grid-cols-12 gap-4 h-full transform group-hover:scale-105 transition-transform duration-1000">
                                    {% for i in "123456789012" %}
                                    <div class="bg-blue-500 rounded-lg animate-pulse" style="animation-delay: {{ forloop.counter0 }}00ms"></div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Floating Icons -->
                            <div class="absolute top-4 left-4 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-500">DCM</div>
                            <div class="absolute top-4 right-4 w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center text-green-600 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-500">JPG</div>
                            <div class="absolute bottom-4 left-4 w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-500">PNG</div>
                            <div class="absolute bottom-4 right-4 w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center text-orange-600 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-500">MRI</div>

                            <!-- Main Content -->
                            <div class="relative z-10">
                                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg group-hover:scale-110 transition-transform duration-500">
                                    <span class="text-3xl text-white">üì§</span>
                                </div>
                                <p class="text-2xl font-bold text-gray-800 mb-3 group-hover:text-gray-900 transition-colors">
                                    Drop images or click to browse
                                </p>
                                <p class="text-gray-500 group-hover:text-gray-600 transition-colors">
                                    Accepted formats: <span id="acceptedFormats" class="font-semibold text-blue-600">.dcm</span>
                                    ¬∑ directories supported
                                </p>
                                <div class="mt-4 flex justify-center space-x-2">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">DICOM</span>
                                    <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">JPEG</span>
                                    <span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">PNG</span>
                                </div>
                            </div>
                            <input
                                type="file"
                                id="fileInput"
                                name="dicom_files"
                                multiple
                                webkitdirectory
                                directory
                                class="hidden"
                            />
                        </div>
                    </div>

                    <!-- File List -->
                    <div class="file-list mb-6 space-y-3 max-h-64 overflow-y-auto scrollbar-thin scrollbar-thumb-blue-200 scrollbar-track-transparent" id="fileList" aria-live="polite"></div>
                    
                    <!-- Error Message -->
                    <div class="error-message mb-4" id="errorMessage"></div>

                    <!-- Process Button -->
                    <button
                        type="submit"
                        class="w-full group relative py-4 px-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500/30 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-lg overflow-hidden"
                        id="processButton"
                        disabled
                    >
                        <span class="relative z-10 flex items-center justify-center">
                            <span class="mr-3 text-xl group-hover:scale-110 transition-transform">‚ö°</span>
                            Process Images
                            <span class="ml-2 text-sm opacity-90">(</span>
                            <span id="fileCount" class="mx-1 text-sm opacity-90">0</span>
                            <span class="text-sm opacity-90">files)</span>
                        </span>
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-700 to-purple-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300 -z-10"></div>
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Modern Processing Modal -->
<div
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden transition-all duration-300"
    id="processingModal"
    role="alertdialog"
    aria-modal="true"
    aria-labelledby="processingHeading"
    aria-describedby="processingStatus"
>
    <div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl p-10 max-w-lg w-full mx-4 border border-white/50 transform transition-all duration-300 scale-95 animate-scale-in">
        <!-- Animated Icon -->
        <div class="relative w-24 h-24 mx-auto mb-6">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl opacity-20 animate-pulse"></div>
            <div class="absolute inset-2 border-4 border-blue-200 rounded-xl animate-spin"></div>
            <div class="absolute inset-4 border-4 border-transparent border-t-blue-500 rounded-lg animate-spin" style="animation-duration: 1.5s"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl">‚öôÔ∏è</span>
            </div>
        </div>

        <h2 id="processingHeading" class="text-2xl font-bold text-gray-900 text-center mb-6">Processing Images</h2>
        
        <!-- Progress Bar -->
        <div class="mb-6">
            <div class="w-full bg-gray-200/80 rounded-full h-3 mb-3 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500 ease-out shadow-inner" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span>0%</span>
                <span id="progressPercentage">0%</span>
                <span>100%</span>
            </div>
        </div>
        
        <p class="text-gray-600 text-center mb-8 text-lg font-medium" id="processingStatus">Initializing upload process‚Ä¶</p>

        <!-- Processing Steps -->
        <div class="space-y-4">
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-blue-50/50 border border-blue-200/50" data-step="upload">
                <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white font-bold">1</div>
                <div>
                    <div class="font-semibold text-gray-900">Uploading Files</div>
                    <div class="text-sm text-gray-600">Securely transferring your medical images</div>
                </div>
                <div class="ml-auto">
                    <div class="w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-gray-100/50 border border-gray-200/50" data-step="validation">
                <div class="w-10 h-10 bg-gray-400 rounded-xl flex items-center justify-center text-white font-bold">2</div>
                <div>
                    <div class="font-semibold text-gray-600">Validating Images</div>
                    <div class="text-sm text-gray-500">Checking format and quality standards</div>
                </div>
            </div>
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-gray-100/50 border border-gray-200/50" data-step="processing">
                <div class="w-10 h-10 bg-gray-400 rounded-xl flex items-center justify-center text-white font-bold">3</div>
                <div>
                    <div class="font-semibold text-gray-600">Processing Images</div>
                    <div class="text-sm text-gray-500">AI-powered enhancement and analysis</div>
                </div>
            </div>
            <div class="processing-step flex items-center space-x-4 p-4 rounded-2xl bg-gray-100/50 border border-gray-200/50" data-step="complete">
                <div class="w-10 h-10 bg-gray-400 rounded-xl flex items-center justify-center text-white font-bold">4</div>
                <div>
                    <div class="font-semibold text-gray-600">Completing Process</div>
                    <div class="text-sm text-gray-500">Finalizing and preparing results</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes scale-in {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    .animate-scale-in {
        animation: scale-in 0.3s ease-out;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    
    .scrollbar-thumb-blue-200::-webkit-scrollbar-thumb {
        background-color: #bfdbfe;
        border-radius: 3px;
    }
    
    .scrollbar-track-transparent::-webkit-scrollbar-track {
        background: transparent;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const uploadForm = document.getElementById("uploadForm");
    const processingModal = document.getElementById("processingModal");
    const progressBar = document.getElementById("progressBar");
    const progressPercentage = document.getElementById("progressPercentage");
    const processingStatus = document.getElementById("processingStatus");
    const errorMessage = document.getElementById("errorMessage");
    const datasetType = document.getElementById("datasetType");
    const acceptedFormats = document.getElementById("acceptedFormats");
    const fileCount = document.getElementById("fileCount");
    const processButton = document.getElementById("processButton");

    // File type configurations
    const fileTypes = {
        dicom: {
            accept: ".dcm",
            formats: ["application/dicom"],
            color: "blue"
        },
        "cbis-ddsm": {
            accept: ".jpg,.jpeg,.png",
            formats: ["image/jpeg", "image/png"],
            color: "green"
        },
        mri: {
            accept: ".jpg,.jpeg,.png",
            formats: ["image/jpeg", "image/png"],
            color: "purple"
        },
    };

    // Dataset selector handling
    document.querySelectorAll(".dataset-option").forEach((option) => {
        option.addEventListener("click", () => {
            document.querySelectorAll(".dataset-option").forEach((opt) => {
                opt.classList.remove("bg-gradient-to-r", "from-blue-600", "to-blue-700", "text-white", "shadow-lg");
                opt.classList.add("bg-white/80", "text-gray-700", "border", "border-gray-200/50");
            });
            
            const type = option.dataset.type;
            const typeConfig = fileTypes[type];
            
            option.classList.remove("bg-white/80", "text-gray-700", "border", "border-gray-200/50");
            option.classList.add("bg-gradient-to-r", "from-blue-600", "to-blue-700", "text-white", "shadow-lg");
            datasetType.value = type;

            // Update file input name based on dataset type
            if (type === "dicom") {
                fileInput.name = "dicom_files";
                fileInput.accept = typeConfig.accept;
                acceptedFormats.textContent = typeConfig.accept;
            } else {
                fileInput.name = "jpeg_files";
                fileInput.accept = typeConfig.accept;
                acceptedFormats.textContent = typeConfig.accept;
            }

            clearFiles();
        });
    });

    // Drag and drop handlers
    dropzone.addEventListener("click", () => fileInput.click());

    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ["dragenter", "dragover"].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => {
            dropzone.classList.add("border-blue-400", "bg-blue-50", "scale-105");
        });
    });

    ["dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => {
            dropzone.classList.remove("border-blue-400", "bg-blue-50", "scale-105");
        });
    });

    // File handling
    dropzone.addEventListener("drop", handleDrop);
    fileInput.addEventListener("change", handleFiles);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const items = dt.items;

        // Check if any items are directories
        let hasDirectories = false;
        for (let i = 0; i < items.length; i++) {
            const entry = items[i].webkitGetAsEntry();
            if (entry && entry.isDirectory) {
                hasDirectories = true;
                break;
            }
        }

        if (hasDirectories) {
            fileInput.webkitdirectory = true;
            fileInput.click();
        } else {
            const files = dt.files;
            validateAndHandleFiles(files);
        }
    }

    function handleFiles(e) {
        const files = e.target.files;
        validateAndHandleFiles(files);
        fileInput.webkitdirectory = false;
    }

    function validateAndHandleFiles(files) {
        const validFiles = [];
        const currentType = datasetType.value;
        const allowedFormats = fileTypes[currentType].formats;

        Array.from(files).forEach((file) => {
            const extension = file.name.toLowerCase().split(".").pop();
            if (currentType === "dicom" && extension === "dcm") {
                validFiles.push(file);
            } else if (
                ["cbis-ddsm", "mri"].includes(currentType) &&
                ["jpg", "jpeg", "png"].includes(extension)
            ) {
                validFiles.push(file);
            }
        });

        if (validFiles.length === 0) {
            showError(`Please upload valid ${currentType.toUpperCase()} files`);
            return;
        }

        updateFileList(validFiles);
        errorMessage.innerHTML = "";
    }

    function updateFileList(files) {
        fileList.innerHTML = "";
        let totalFiles = 0;

        // Group files by directory
        const filesByDirectory = {};

        Array.from(files).forEach((file) => {
            const pathParts = file.webkitRelativePath
                ? file.webkitRelativePath.split("/")
                : [file.name];
            const directory = pathParts.length > 1 ? pathParts[0] : "Root";

            if (!filesByDirectory[directory]) {
                filesByDirectory[directory] = [];
            }
            filesByDirectory[directory].push(file);
            totalFiles++;
        });

        // Display files grouped by directory
        for (const [directory, dirFiles] of Object.entries(filesByDirectory)) {
            if (Object.keys(filesByDirectory).length > 1) {
                const dirHeader = document.createElement("div");
                dirHeader.className = "flex items-center space-x-2 mt-4 mb-3 p-3 bg-gray-100/50 rounded-xl";
                dirHeader.innerHTML = `
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    <span class="font-semibold text-blue-700">${directory}</span>
                    <span class="text-sm text-gray-500">(${dirFiles.length} files)</span>
                `;
                fileList.appendChild(dirHeader);
            }

            dirFiles.forEach((file, index) => {
                const fileItem = document.createElement("div");
                fileItem.className = "flex items-center justify-between p-4 bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 hover:border-blue-200/50 transition-all duration-200 group";

                const size = formatFileSize(file.size);
                const type = file.name.split(".").pop().toUpperCase();
                const displayName = file.webkitRelativePath
                    ? file.webkitRelativePath.split("/").slice(1).join("/")
                    : file.name;

                fileItem.innerHTML = `
                    <div class="flex items-center space-x-4 flex-1 min-w-0">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-sm">
                            ${type.substring(0, 3)}
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="font-medium text-gray-900 truncate">${displayName}</div>
                            <div class="text-sm text-gray-500 flex items-center space-x-2">
                                <span>${type}</span>
                                <span>‚Ä¢</span>
                                <span>${size}</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="opacity-0 group-hover:opacity-100 w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg flex items-center justify-center transition-all duration-200 transform hover:scale-110 remove-file" data-index="${index}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;

                fileList.appendChild(fileItem);
            });
        }

        // Update file count and button state
        fileCount.textContent = totalFiles;
        const dataTransfer = new DataTransfer();
        Array.from(files).forEach((file) => {
            dataTransfer.items.add(file);
        });
        fileInput.files = dataTransfer.files;
        processButton.disabled = false;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function showError(message) {
        errorMessage.innerHTML = `
            <div class="bg-red-50/80 backdrop-blur-sm border border-red-200 rounded-2xl p-4 shadow-lg animate-fade-in">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="text-red-800 font-medium">${message}</div>
                </div>
            </div>
        `;
    }

    function clearFiles() {
        fileList.innerHTML = "";
        fileInput.value = "";
        errorMessage.innerHTML = "";
        fileCount.textContent = "0";
        processButton.disabled = true;
    }

    // Form submission
    uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (fileList.children.length === 0) {
            showError("Please select files to upload");
            return;
        }

        const formData = new FormData();
        const datasetType = document.getElementById("datasetType").value;
        const files = fileInput.files;

        Array.from(files).forEach((file) => {
            if (datasetType === "dicom") {
                formData.append("dicom_files", file);
            } else {
                formData.append("jpeg_files", file);
            }
        });

        formData.append("dataset_type", datasetType);

        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        processingModal.classList.remove("hidden");
        updateProcessingStep("upload");

        try {
            const response = await fetch("", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": csrfToken,
                    "X-Requested-With": "XMLHttpRequest",
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.status === "success") {
                const imageId = data.image_id;
                let progress = 0;

                const pollInterval = setInterval(async () => {
                    try {
                        progress += 2;
                        if (progress > 100) progress = 100;
                        progressBar.style.width = `${progress}%`;
                        progressPercentage.textContent = `${progress}%`;

                        if (progress <= 25) {
                            updateProcessingStep("upload");
                            processingStatus.textContent = "Uploading files securely...";
                        } else if (progress <= 50) {
                            updateProcessingStep("validation");
                            processingStatus.textContent = "Validating image quality...";
                        } else if (progress <= 85) {
                            updateProcessingStep("processing");
                            processingStatus.textContent = "Processing with AI models...";
                        } else {
                            updateProcessingStep("complete");
                            processingStatus.textContent = "Finalizing results...";
                        }

                        if (progress % 10 === 0) {
                            const statusResponse = await fetch(`/progress/${imageId}/`, {
                                headers: {
                                    "X-Requested-With": "XMLHttpRequest",
                                },
                            });

                            if (statusResponse.ok) {
                                const statusData = await statusResponse.json();
                                if (statusData.status === "completed" || statusData.redirect) {
                                    clearInterval(pollInterval);
                                    window.location.href = statusData.redirect || data.redirect_url;
                                    return;
                                }
                            }
                        }

                        if (progress >= 100) {
                            clearInterval(pollInterval);
                            window.location.href = data.redirect_url;
                        }
                    } catch (error) {
                        console.error("Status check error:", error);
                        if (progress >= 100) {
                            clearInterval(pollInterval);
                            window.location.href = data.redirect_url;
                        }
                    }
                }, 300);
            } else {
                throw new Error(data.message || "Upload failed");
            }
        } catch (error) {
            console.error("Upload error:", error);
            showError(error.message || "An error occurred during upload");
            processingModal.classList.add("hidden");
        }
    });

    function updateProcessingStep(step) {
        document.querySelectorAll(".processing-step").forEach((s) => {
            s.classList.remove("bg-blue-50/50", "border-blue-200/50");
            s.classList.add("bg-gray-100/50", "border-gray-200/50");
            
            const numberDiv = s.querySelector("div:first-child");
            const spinner = s.querySelector("div:last-child .animate-spin");
            
            numberDiv.classList.remove("bg-blue-500", "bg-gray-400");
            numberDiv.classList.add("bg-gray-400");
            
            if (spinner) {
                spinner.classList.add("hidden");
            }
            
            if (s.dataset.step === step) {
                s.classList.remove("bg-gray-100/50", "border-gray-200/50");
                s.classList.add("bg-blue-50/50", "border-blue-200/50");
                numberDiv.classList.remove("bg-gray-400");
                numberDiv.classList.add("bg-blue-500");
                
                if (spinner) {
                    spinner.classList.remove("hidden");
                }
            }
        });
    }
</script>
{% endblock %}